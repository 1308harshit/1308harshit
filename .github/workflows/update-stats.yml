name: Update GitHub Stats

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch: # Manual trigger

permissions:
  contents: write

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Get Private GitHub Stats
        id: get-stats
        run: |
          # Get total PR count (including private repos)
          PR_COUNT=$(curl -s -H "Authorization: Bearer ${{ secrets.GH_PAT }}" \
               -H "Accept: application/vnd.github+json" \
               "https://api.github.com/search/issues?q=type:pr+author:1308harshit" \
               | jq -r '.total_count')

          # Get user info including private repos
          USER_INFO=$(curl -s -H "Authorization: Bearer ${{ secrets.GH_PAT }}" \
               -H "Accept: application/vnd.github+json" \
               "https://api.github.com/users/1308harshit")

          PUBLIC_REPOS=$(echo $USER_INFO | jq -r '.public_repos')
          PRIVATE_REPOS=$(echo $USER_INFO | jq -r '.total_private_repos')

          # Get total commits (estimate based on public + private)
          TOTAL_COMMITS=$(curl -s -H "Authorization: Bearer ${{ secrets.GH_PAT }}" \
               -H "Accept: application/vnd.github+json" \
               "https://api.github.com/search/commits?q=author:1308harshit" \
               | jq -r '.total_count')

          echo "PR_COUNT=$PR_COUNT" >> $GITHUB_OUTPUT
          echo "PUBLIC_REPOS=$PUBLIC_REPOS" >> $GITHUB_OUTPUT
          echo "PRIVATE_REPOS=$PRIVATE_REPOS" >> $GITHUB_OUTPUT
          echo "TOTAL_COMMITS=$TOTAL_COMMITS" >> $GITHUB_OUTPUT

          echo "Real Stats:"
          echo "Total PRs: $PR_COUNT"
          echo "Public Repos: $PUBLIC_REPOS"
          echo "Private Repos: $PRIVATE_REPOS"
          echo "Total Commits: $TOTAL_COMMITS"

      - name: Update README with Real Stats
        run: |
          PR_COUNT="${{ steps.get-stats.outputs.PR_COUNT }}"
          PUBLIC_REPOS="${{ steps.get-stats.outputs.PUBLIC_REPOS }}"
          PRIVATE_REPOS="${{ steps.get-stats.outputs.PRIVATE_REPOS }}"
          TOTAL_COMMITS="${{ steps.get-stats.outputs.TOTAL_COMMITS }}"
          
          # Set timezone to IST (UTC+5:30) and get current time
          export TZ="Asia/Kolkata"
          
          # Get current time in IST
          CURRENT_TIME_IST=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M IST")
          
          # Fallback if timezone doesn't work
          if [ -z "$CURRENT_TIME_IST" ]; then
            # Manual IST conversion (UTC + 5:30)
            UTC_TIME=$(date -u +"%Y-%m-%d %H:%M")
            CURRENT_TIME_IST="${UTC_TIME} IST"
          fi

          # Replace placeholder text in README.md
          sed -i "s/- \*\*Total Pull Requests\*\*: \[Auto-updated via GitHub Actions\]/- \*\*Total Pull Requests\*\*: **$PR_COUNT**/" README.md
          sed -i "s/- \*\*Public Repositories\*\*: \[Auto-updated via GitHub Actions\]/- \*\*Public Repositories\*\*: **$PUBLIC_REPOS**/" README.md
          sed -i "s/- \*\*Private Repositories\*\*: \[Auto-updated via GitHub Actions\]/- \*\*Private Repositories\*\*: **$PRIVATE_REPOS**/" README.md
          sed -i "s/- \*\*Total Commits\*\*: \[Auto-updated via GitHub Actions\]/- \*\*Total Commits\*\*: **$TOTAL_COMMITS**/" README.md
          sed -i "s/- \*\*Last Updated\*\*: \[Auto-updated via GitHub Actions\]/- \*\*Last Updated\*\*: **$CURRENT_TIME_IST**/" README.md

          echo "Updated README with real stats:"
          echo "Total PRs: $PR_COUNT"
          echo "Public Repos: $PUBLIC_REPOS"
          echo "Private Repos: $PRIVATE_REPOS"
          echo "Total Commits: $TOTAL_COMMITS"
          echo "Last Updated: $CURRENT_TIME_IST"
          echo "Timezone: $TZ"

      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "Update README with real GitHub statistics: ${{ steps.get-stats.outputs.PR_COUNT }} PRs, ${{ steps.get-stats.outputs.PRIVATE_REPOS }} private repos" || exit 0
          git push origin main
